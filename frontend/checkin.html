<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tela de Check-in</title>
    <script>
      if (!sessionStorage.getItem('user') || !sessionStorage.getItem('token')) {
        window.location.replace('login.html');
      }
    </script>
        <link rel="icon" type="image/x-icon" href="imagens/logo_branco .svg" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="imagens/logo_branco .svg"
    />
    <link rel="logo" href="imagens/logo_branco .svg" />
    <!-- Scripts de autentica√ß√£o e UI -->
    <script src="js/auth.js"></script>
    <script src="js/ui.js"></script>
    <style>
      :root {
        --background-color: #f4f7fa;
        --sidebar-bg: #ffffff;
        --card-bg: #ffffff;
        --text-color: #4a5568;
        --heading-color: #1a202c;
        --primary-color: #4a90e2;
        --border-color: #e2e8f0;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      body {
        display: flex;
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: "Inter", sans-serif;
      }
      .container {
        display: flex;
        width: 100%;
        min-height: 100vh;
      }
      .sidebar {
        width: 240px;
        background-color: var(--sidebar-bg);
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        transition: width 0.3s;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      .sidebar-header {
        margin-bottom: 2.5rem;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--heading-color);
        text-align: center;
      }
      .date-time {
        text-align: center;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        line-height: 1.4;
        min-height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .nav-menu {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .menu-btn {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-color);
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
      }
      .menu-btn:hover,
      .menu-btn.active {
        background-color: var(--primary-color);
        color: #fff;
      }

      /* Estilos do User Card */
      .user-card {
        margin-top: auto;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .user-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .user-name {
        font-weight: 600;
        color: var(--heading-color);
        font-size: 0.95rem;
      }

      .user-role {
        font-size: 0.8rem;
        color: var(--text-color);
        opacity: 0.8;
      }

      .logout-btn {
        background-color: #e53e3e;
        color: white;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.2s;
      }

      .logout-btn:hover {
        background-color: #c53030;
      }

      .main-content {
        flex-grow: 1;
        padding: 2rem;
        overflow: auto;
      }

      /* Container Principal */
      .checkoutscreencontainer {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        color: #333;
        background-color: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 480px;
        margin: 40px auto;
      }

      /* Cabe√ßalho */
      .checkoutscreenheader {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
      }

      .checkoutscreenback_arrow {
        font-size: 28px;
        text-decoration: none;
        color: #555;
        margin-right: 20px;
        cursor: pointer;
      }

      .checkoutscreentitle_box {
        background-color: #357abd;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        text-align: center;
        flex-grow: 1;
      }

      .checkoutscreenmain_title {
        margin: 0;
        font-size: 24px;
        font-weight: 500;
      }

      /* Formul√°rio */
      .checkoutscreenform {
        width: 100%;
      }

      .checkoutscreencolumns_wrapper {
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      .checkoutscreencolumn {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      /* Campos */
      .checkoutscreenfield_group {
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      .checkoutscreenlabel {
        margin-bottom: 6px;
        font-weight: 500;
        color: #555;
      }

      .checkoutscreeninput {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        width: 100%;
        box-sizing: border-box;
      }

      .checkoutscreeninput:focus {
        outline: none;
        border-color: #357abd;
        box-shadow: 0 0 5px rgba(53, 122, 189, 0.5);
      }

      /* Bot√£o Registrar */
      .checkoutscreensubmit_button {
        background-color: #357abd;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
        padding: 5px 28px;
        height: 39px;
        min-width: 100px;
        align-self: flex-start;
        margin-top: 12px;
      }

      .checkoutscreensubmit_button:hover {
        background-color: #2c639a; /* tom um pouco mais escuro para o hover */
      }

      /* Estilo para o container dos acompanhantes */
      .acompanhante-field-group {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      /* Responsivo */
      @media (max-width: 600px) {
        .checkoutscreencontainer {
          padding: 15px;
        }
        .checkoutscreentitle_box {
          font-size: 18px;
          padding: 8px 10px;
        }
        .checkoutscreenmain_title {
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <img src="imagens/LOGO HOTEL azul .svg.svg" alt="" />
          </div>
          <div class="date-time" id="dateTime"></div>
        </div>
        <nav class="nav-menu">
          <a href="index.html" class="menu-btn">üè† √çnicio</a>
          <a href="checkin.html" class="menu-btn active">üì• Check-in</a>
          <a href="checkout.html" class="menu-btn">üì§ Check-out</a>
          <a href="clientes.html" class="menu-btn">üë§ Clientes</a>
          <a href="quartos.html" class="menu-btn">üõèÔ∏è Quartos</a>
          <a href="reservas.html" class="menu-btn">üìã Reservas</a>
          <a href="produtos.html" class="menu-btn">üõí Produtos</a>
          <a href="calendario.html" class="menu-btn">üìÖ Calend√°rio</a>
          <a href="gerenciamento_usuarios.html" class="menu-btn" id="usuariosMenuBtn" style="display: none;">üë• Usu√°rios</a>
        </nav>
        <div class="user-card">
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">‚Äî</div>
            <div class="user-role" id="sidebarUserRole">padr√£o</div>
          </div>
          <button class="logout-btn" id="sidebarLogoutBtn">Sair</button>
        </div>
      </aside>

      <main class="main-content">
        <div class="checkoutscreencontainer">
          <div class="checkoutscreenheader">
            <a class="checkoutscreenback_arrow" onclick="VoltarPagina()">‚Üê</a>
            <div class="checkoutscreentitle_box">
              <h2 class="checkoutscreenmain_title">Check-In</h2>
            </div>
          </div>
          <form class="checkoutscreenform" id="checkinForm">
            <div class="checkoutscreencolumns_wrapper">
              <div class="checkoutscreencolumn">
                <div class="checkoutscreenfield_group">
                  <label for="documentocliente"
                    >CPF ou Passaporte cliente (obrigat√≥rio):</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="documentocliente"
                    name="documentocliente"
                  />
                </div>
                <input
                  type="hidden"
                  id="idcliente_hidden"
                  name="idcliente_hidden"
                  value=""
                />
                <input
                  type="hidden"
                  id="cpfcliente_hidden"
                  name="cpfcliente_hidden"
                  value=""
                />
                <input
                  type="hidden"
                  id="passaportecliente_hidden"
                  name="passaportecliente_hidden"
                  value=""
                />
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="nomecliente"
                    >Nome do Cliente</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="nomecliente"
                    name="nomecliente"
                    readonly
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="telefonecliente"
                    >Telefone</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="telefonecliente"
                    name="telefonecliente"
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="emailcliente"
                    >Email</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="emailcliente"
                    name="emailcliente"
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="cepcliente"
                    >CEP</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="cepcliente"
                    name="cepcliente"
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="enderecocliente"
                    >Endere√ßo</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="enderecocliente"
                    name="enderecocliente"
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="motivo_hospedagem"
                    >Motivo da hospedagem</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="motivo_hospedagem"
                    name="motivo_hospedagem"
                    maxlength="100"
                    placeholder="Motivo da hospedagem"
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label
                    class="checkoutscreenlabel"
                    for="quantidade_acompanhantes"
                    >Quantidade de acompanhantes</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="number"
                    id="quantidade_acompanhantes"
                    name="quantidade_acompanhantes"
                    min="0"
                    max="10"
                    placeholder="0"
                  />
                </div>
                <div id="acompanhantes-container"></div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="datacheckin"
                    >Data Check-In:</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="date"
                    id="datacheckin"
                    name="datacheckin"
                    required
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="horacheckin"
                    >Hora Check-In:</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="time"
                    id="horacheckin"
                    name="horacheckin"
                    required
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="datacheckoutprrevista"
                    >Data Check-out Prevista:</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="date"
                    id="datacheckoutprrevista"
                    name="datacheckoutprrevista"
                    required
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="horacheckoutprevista"
                    >Hora Check-out Prevista:</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="time"
                    id="horacheckoutprevista"
                    name="horacheckoutprevista"
                    required
                  />
                </div>
                <div class="checkoutscreenfield_group">
                  <div class="checkoutscreenfield_group">
                    <label class="checkoutscreenlabel" for="quarto"
                      >Quarto</label
                    >
                    <select
                      class="checkoutscreeninput"
                      id="quarto"
                      name="quarto"
                      required
                    ></select>
                    <div
                      id="quarto-detalhes"
                      style="
                        margin-top: 8px;
                        padding: 10px;
                        background-color: #f4f7fa;
                        border-radius: 5px;
                        color: #555;
                      "
                    >
                      Selecione um quarto para ver os detalhes.
                    </div>
                  </div>
                </div>
                <div class="checkoutscreenfield_group">
                  <label class="checkoutscreenlabel" for="valor_diaria"
                    >Valor da di√°ria</label
                  >
                  <input
                    class="checkoutscreeninput"
                    type="text"
                    id="valor_diaria"
                    name="valor_diaria"
                  />
                </div>
                <div class="form-group">
                  <label for="pago_booking">Pagamento feito pelo Booking?</label>
                  <select id="pago_booking" name="pago_booking" class="form-control">
                    <option value="0">N√£o</option>
                    <option value="1">Sim</option>
                  </select>
                </div>
                <button class="checkoutscreensubmit_button" type="submit">
                  Registrar
                </button>
              </div>
            </div>
          </form>
        </div>
      </main>
    </div>

    <script>
      function formatarDocumento(item) {
        if (item?.cpf && item.cpf.trim() !== "") return `CPF: ${item.cpf}`;
        if (item?.passaporte && item.passaporte.trim() !== "")
          return `Passaporte: ${item.passaporte}`;
        return "N/A";
      }
      function updateDateTime() {
        const now = new Date();
        const date = now.toLocaleDateString("pt-BR", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        });
        const time = now.toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        const el = document.getElementById("dateTime");
        if (el) el.innerHTML = `${date}<br>${time}`;
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      function VoltarPagina() {
        window.location.href = "index.html";
      }

      // Vari√°vel para guardar os dados de todos os quartos e evitar chamadas repetidas √† API
      let todosOsQuartos = [];

      // Fun√ß√£o para buscar e preencher os detalhes do quarto selecionado
      function atualizarDetalhesQuarto() {
        const selectQuarto = document.getElementById("quarto");
        const numeroQuarto = selectQuarto.value;
        const valorDiariaInput = document.getElementById("valor_diaria");
        const detalhesDiv = document.getElementById("quarto-detalhes");
        

        if (!numeroQuarto) {
          valorDiariaInput.value = "";
          detalhesDiv.innerHTML = "Selecione um quarto para ver os detalhes.";
          return;
        }

        // Encontra o quarto selecionado nos dados que j√° carregamos
        const quarto = todosOsQuartos.find((q) => q.numero == numeroQuarto);

        if (quarto) {
          valorDiariaInput.value = quarto.valor_diaria || "";
          detalhesDiv.innerHTML = `<strong>${
            quarto.descricao
          }</strong><br>Valor: R$ ${Number(quarto.valor_diaria).toFixed(2)}`;
        } else {
          valorDiariaInput.value = "";
          detalhesDiv.innerHTML = "N√£o foi poss√≠vel carregar os detalhes.";
        }
      }

      // Fun√ß√£o para carregar a lista de quartos dispon√≠veis no dropdown
      async function carregarQuartosDisponiveis() {
        const select = document.getElementById("quarto");
        const detalhesDiv = document.getElementById("quarto-detalhes");
        select.innerHTML = '<option value="">Carregando...</option>';
        try {
          const resp = await fetch("/api/quartos");
          const quartos = await resp.json();
          todosOsQuartos = quartos; // Salva os quartos na vari√°vel
          const disponiveis = quartos.filter((q) => q.status === "disponivel");

          if (!disponiveis.length) {
            select.innerHTML =
              '<option value="">Nenhum quarto dispon√≠vel</option>';
            detalhesDiv.innerHTML = ""; // Limpa os detalhes
            return;
          }

          select.innerHTML = '<option value="">Selecione um quarto</option>'; // Adiciona uma op√ß√£o padr√£o
          select.innerHTML += disponiveis
            .map(
              (q) => `<option value="${q.numero}">Quarto ${q.numero}</option>`
            )
            .join("");

          atualizarDetalhesQuarto();
        } catch (error) {
          select.innerHTML =
            '<option value="">Erro ao carregar quartos</option>';
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // --- M√°scara visual de CPF (campo principal) ---
        const docClienteInput = document.getElementById("documentocliente");
        function formatarCPF(cpf) {
          cpf = cpf.replace(/\D/g, "");
          if (cpf.length > 11) cpf = cpf.slice(0, 11);
          if (cpf.length <= 3) return cpf;
          if (cpf.length <= 6) return cpf.slice(0, 3) + "." + cpf.slice(3);
          if (cpf.length <= 9) return cpf.slice(0, 3) + "." + cpf.slice(3, 6) + "." + cpf.slice(6);
          return cpf.slice(0, 3) + "." + cpf.slice(3, 6) + "." + cpf.slice(6, 9) + "-" + cpf.slice(9);
        }
        if (docClienteInput) {
          docClienteInput.addEventListener("input", (e) => {
            const val = e.target.value;
            // s√≥ mascara se for CPF (evita atrapalhar passaporte)
            if (/^[0-9 .-]*$/.test(val)) {
              const pos = e.target.selectionStart;
              const old = e.target.value;
              e.target.value = formatarCPF(old);
              if (e.target.value.length > old.length && pos != null) e.target.setSelectionRange(pos + 1, pos + 1);
            }
          });
        }

        // Carrega os quartos assim que a p√°gina √© aberta
        carregarQuartosDisponiveis();

        // Adiciona o listener para quando o usu√°rio muda a sele√ß√£o do quarto
        document
          .getElementById("quarto")
          .addEventListener("change", atualizarDetalhesQuarto);

        // Preencher dados do cliente ao digitar o CPF
        // Fun√ß√£o auxiliar para limpar campos de cliente e hidden
        function limparDadosCliente() {
          document.getElementById("idcliente_hidden").value = "";
          document.getElementById("nomecliente").value = "";
          document.getElementById("telefonecliente").value = "";
          document.getElementById("emailcliente").value = "";
          document.getElementById("cepcliente").value = "";
          document.getElementById("enderecocliente").value = "";
          document.getElementById("cpfcliente_hidden").value = "";
          document.getElementById("passaportecliente_hidden").value = "";
        }

        // Fun√ß√£o para buscar cliente por CPF ou Passaporte (Unificado)
        async function buscarClientePorDocumento(documento) {
          // Remove formata√ß√£o (pontos, tra√ßos, barras)
          const documentoLimpo = documento.replace(/[.\-/]/g, "").trim();

          if (!documentoLimpo) return null;

          // 1. Tenta buscar por CPF (assume CPF se tiver 11 d√≠gitos, ou se for totalmente num√©rico)
          if (documentoLimpo.length === 11 && /^\d+$/.test(documentoLimpo)) {
            try {
              const resp = await fetch(`/api/clientes/cpf/${documentoLimpo}`);
              if (resp.ok) {
                return { cliente: await resp.json(), tipo: "cpf" };
              }
            } catch (error) {
              console.error("Erro ao buscar cliente por CPF:", error);
            }
          }

          // 2. Tenta buscar por Passaporte, usando o valor original para o encode
          try {
            const resp = await fetch(
              `/api/clientes/passaporte/${encodeURIComponent(documento)}`
            );
            if (resp.ok) {
              return { cliente: await resp.json(), tipo: "passaporte" };
            }
          } catch (error) {
            console.error("Erro ao buscar cliente por passaporte:", error);
          }

          return null; // N√£o encontrou
        }

        // NOVO: Fun√ß√£o para processar a entrada do documento e preencher campos
        async function processarDocumentoCliente(
          documentoDigitado,
          exibirAlerta = false
        ) {
          if (!documentoDigitado) {
            limparDadosCliente();
            return;
          }

          const resultado = await buscarClientePorDocumento(documentoDigitado);
          limparDadosCliente(); // Limpa antes de preencher

          if (resultado && resultado.cliente) {
            const cliente = resultado.cliente;

            document.getElementById("idcliente_hidden").value = cliente.id || "";
            document.getElementById("nomecliente").value = cliente.nome || "";
            document.getElementById("telefonecliente").value =
              cliente.telefone || "";
            document.getElementById("emailcliente").value = cliente.email || "";
            document.getElementById("cepcliente").value = cliente.cep || "";
            document.getElementById("enderecocliente").value =
              cliente.endereco || "";

            // Salva o CPF e Passaporte nos campos hidden para uso no submit
            document.getElementById("cpfcliente_hidden").value =
              cliente.cpf || "";
            document.getElementById("passaportecliente_hidden").value =
              cliente.passaporte || "";
          } else {
            // Cliente n√£o encontrado. Define o documento digitado nos campos hidden.
            const documentoLimpo = documentoDigitado
              .replace(/[.\-/]/g, "")
              .trim();
            if (documentoLimpo.length === 11 && /^\d+$/.test(documentoLimpo)) {
              document.getElementById("cpfcliente_hidden").value =
                documentoLimpo;
            } else {
              document.getElementById("passaportecliente_hidden").value =
                documentoDigitado;
            }

            if (exibirAlerta) {
              alert(
                "Cliente n√£o encontrado. Preencha os dados restantes. Se este for um cliente novo, ele ser√° cadastrado no check-in."
              );
            }
          }
        }

        // Listener de blur chama a nova fun√ß√£o e exibe o alerta (mantendo a usabilidade original)
        document
          .getElementById("documentocliente")
          .addEventListener("blur", async function () {
            await processarDocumentoCliente(this.value, true);
          });

        // Gerar campos de acompanhantes dinamicamente
        document
          .getElementById("quantidade_acompanhantes")
          .addEventListener("input", function () {
            const quantidade = parseInt(this.value, 10) || 0;
            const container = document.getElementById(
              "acompanhantes-container"
            );
            container.innerHTML = "";

            for (let i = 1; i <= quantidade; i++) {
              const div = document.createElement("div");
              div.className = "acompanhante-field-group";
              div.innerHTML = `
                  <div class="checkoutscreenfield_group">
                      <label class="checkoutscreenlabel">Nome do acompanhante ${i}:</label>
                      <input type="text" class="checkoutscreeninput nome-acompanhante" name="nome_acompanhante_${i}" />
                  </div>
                  <div class="checkoutscreenfield_group">
                      <label class="checkoutscreenlabel">CPF ou Passaporte do acompanhante ${i}:</label>
                      <input type="text" class="checkoutscreeninput documento-acompanhante" name="documento_acompanhante_${i}" /> </div>
                  <div class="checkoutscreenfield_group">
                      <label class="checkoutscreenlabel">Data de Nascimento do acompanhante ${i}:</label>
                      <input type="date" class="checkoutscreeninput nascimento-acompanhante" name="nascimento_acompanhante_${i}" />
                  </div>
              `;
              container.appendChild(div);
            }
          });

        // Enviar o formul√°rio de check-in
        // Enviar o formul√°rio de check-in
        // Enviar o formul√°rio de check-in
        document
          .getElementById("checkinForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            // *** CORRE√á√ÉO: For√ßa o processamento do documento antes de ler os campos hidden ***
            const documentoDigitado =
              document.getElementById("documentocliente").value;
            await processarDocumentoCliente(documentoDigitado);
            // ********************************************************************************

            // Obt√©m os dados dos campos hidden (que agora t√™m certeza de estarem preenchidos se o campo de input n√£o for vazio)
            const id_cliente =
              document.getElementById("idcliente_hidden").value;
            const cliente_cpf =
              document.getElementById("cpfcliente_hidden").value;
            const passaporte_cliente = document.getElementById(
              "passaportecliente_hidden"
            ).value;

            // Campos restantes
            const quarto_numero = document.getElementById("quarto").value;
            const data_checkin = document.getElementById("datacheckin").value;
            const hora_checkin = document.getElementById("horacheckin").value;
            const data_checkout_prevista = document.getElementById(
              "datacheckoutprrevista"
            ).value;
            const hora_checkout_prevista = document.getElementById(
              "horacheckoutprevista"
            ).value;
            const valor_diaria = document.getElementById("valor_diaria").value;
            const nome = document.getElementById("nomecliente").value;
            const telefone = document.getElementById("telefonecliente").value;
            const email = document.getElementById("emailcliente").value;
            const cep = document.getElementById("cepcliente").value;
            const endereco = document.getElementById("enderecocliente").value;
            const motivo_hospedagem = document.getElementById("motivo_hospedagem").value;
            
            const pago_booking = document.getElementById("pago_booking").value;
            const nomes_acompanhantes = Array.from(
              document.querySelectorAll(".nome-acompanhante")
            ).map((input) => input.value);
            const documentos_acompanhantes = Array.from(
              document.querySelectorAll(".documento-acompanhante")
            ).map((input) => input.value); // NOVO: Campo √∫nico

            const cpfs_acompanhantes = documentos_acompanhantes.map((doc) =>
              doc.replace(/[.\-/]/g, "").trim().length === 11 &&
              /^\d+$/.test(doc.replace(/[.\-/]/g, ""))
                ? doc.replace(/[.\-/]/g, "")
                : null
            );
            const passaportes_acompanhantes = documentos_acompanhantes.map(
              (doc) =>
                doc.replace(/[.\-/]/g, "").trim().length === 11 &&
                /^\d+$/.test(doc.replace(/[.\-/]/g, ""))
                  ? null
                  : doc
            );

            const nascimentos_acompanhantes = Array.from(
              document.querySelectorAll(".nascimento-acompanhante")
            ).map((input) => input.value);

            // Valida√ß√£o: CPF OU Passaporte √© obrigat√≥rio, al√©m dos campos usuais.
            if (
              (!cliente_cpf && !passaporte_cliente) ||
              !quarto_numero ||
              !data_checkin ||
              !hora_checkin ||
              !data_checkout_prevista ||
              !hora_checkout_prevista ||
              !valor_diaria
            ) {
              alert(
                "Preencha todos os campos obrigat√≥rios! (CPF/Passaporte do Cliente, Quarto, Datas/Horas e Valor da Di√°ria)"
              );
              return;
            }

            try {
              // Tenta atualizar o cliente se houver ID (envia CPF e passaporte para passar na valida√ß√£o do backend)
              if (id_cliente) {
                const updateResp = await fetch(`/api/clientes/${id_cliente}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    cpf: cliente_cpf || null,
                    passaporte: passaporte_cliente || null,
                    nome,
                    telefone,
                    email,
                    endereco,
                    cep,
                    data_nascimento: null,
                    nacionalidade: null,
                  }),
                });
                if (!updateResp.ok) {
                  console.warn("PUT /clientes falhou (prosseguindo com check-in):", await updateResp.text());
                }
              } else {
                console.log(
                  "Cliente estrangeiro (sem CPF) ou novo cliente. Pulando PUT de atualiza√ß√£o por CPF."
                );
              }

              const checkinData = {
                cliente_cpf,
                cliente_passaporte: passaporte_cliente,
                quarto_numero,
                data_checkin,
                hora_checkin,
                data_checkout_prevista,
                hora_checkout_prevista,
                valor_diaria,
                motivo_hospedagem,
                nomes_acompanhantes,
                cpfs_acompanhantes,
                passaportes_acompanhantes,
                nascimentos_acompanhantes,
                pago_booking: pago_booking,
              };

              const resp = await fetch("/api/checkin", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(checkinData),
              });
              const data = await resp.json();
              if (resp.ok) {
                alert("Check-in registrado com sucesso!");
                this.reset();
                limparDadosCliente(); // Limpa os campos hidden tamb√©m
                document.getElementById("acompanhantes-container").innerHTML =
                  "";
                carregarQuartosDisponiveis();
              } else if (resp.status === 409 && data.precisa_confirmar) {
                if (confirm(data.message)) {
                  checkinData.ignorar_reserva_ativa = true;
                  const resp2 = await fetch("/api/checkin", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(checkinData),
                  });
                  const data2 = await resp2.json();
                  if (resp2.ok) {
                    alert("Check-in registrado com sucesso!");
                    this.reset();
                    limparDadosCliente(); // Limpa os campos hidden tamb√©m
                    document.getElementById(
                      "acompanhantes-container"
                    ).innerHTML = "";
                    carregarQuartosDisponiveis();
                  } else {
                    alert(data2.message || "Erro ao registrar check-in");
                  }
                }
              } else {
                alert(data.message || "Erro ao registrar check-in");
              }
            } catch (error) {
              alert(
                "Erro ao conectar ao servidor. Verifique o console para mais detalhes."
              );
              console.error(error);
            }
          });
      });
    </script>
  </body>
</html>
